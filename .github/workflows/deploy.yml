name: Deploy Dealio

on:
  push:
    branches:
      - main  # only deploy from main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Build JAR
        run: ./mvnw clean package -DskipTests
      - name: Create env file
        run: |
          set -euo pipefail
          # Helper to escape single quotes safely for single-quoted shell literals
          esc() { printf "%s" "$1" | sed "s/'/'\\''/g"; }

          # Assign secrets to shell variables
          APP_BASE_URL='${{ secrets.APP_BASE_URL }}'

          DB_URL='${{ secrets.DB_URL }}'
          DB_USERNAME='${{ secrets.DB_USERNAME }}'
          DB_PASSWORD='${{ secrets.DB_PASSWORD }}'

          JWT_SECRET='${{ secrets.JWT_SECRET }}'

          OMNICHECK_API_KEY='${{ secrets.OMNICHECK_API_KEY }}'
          OMNICHECK_BASE_URL='${{ secrets.OMNICHECK_BASE_URL }}'

          PAYFAST_ENABLED='${{ secrets.PAYFAST_ENABLED }}'
          PAYFAST_MERCHANT_ID='${{ secrets.PAYFAST_MERCHANT_ID }}'
          PAYFAST_MERCHANT_KEY='${{ secrets.PAYFAST_MERCHANT_KEY }}'
          PAYFAST_PASSPHRASE='${{ secrets.PAYFAST_PASSPHRASE }}'
          PAYFAST_URL='${{ secrets.PAYFAST_URL }}'
          PAYFAST_RETURN_URL='${{ secrets.PAYFAST_RETURN_URL }}'
          PAYFAST_CANCEL_URL='${{ secrets.PAYFAST_CANCEL_URL }}'
          PAYFAST_NOTIFY_URL='${{ secrets.PAYFAST_NOTIFY_URL }}'

          B2_APPLICATION_KEY_ID='${{ secrets.B2_APPLICATION_KEY_ID }}'
          B2_APPLICATION_KEY_NAME='${{ secrets.B2_APPLICATION_KEY_NAME }}'
          B2_APPLICATION_KEY='${{ secrets.B2_APPLICATION_KEY }}'
          B2_BUCKET_ID='${{ secrets.B2_BUCKET_ID }}'
          B2_BUCKET_NAME='${{ secrets.B2_BUCKET_NAME }}'

          MAIL_HOST='${{ secrets.MAIL_HOST }}'
          MAIL_PORT='${{ secrets.MAIL_PORT }}'
          MAIL_USERNAME='${{ secrets.MAIL_USERNAME }}'
          MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}'

          ALLOWED_ORIGINS='${{ secrets.ALLOWED_ORIGINS }}'

          # Write file with safely quoted values
          cat > deploy.env <<EOF
# App & profiles
          printf "PORT='%s'\n" "$(esc 8080)" >> deploy.env
          printf "SPRING_PROFILES_ACTIVE='%s'\n" "$(esc prod)" >> deploy.env
          printf "APP_BASE_URL='%s'\n\n" "$(esc "$APP_BASE_URL")" >> deploy.env

          printf "DB_URL='%s'\n" "$(esc "$DB_URL")" >> deploy.env
          printf "DB_USERNAME='%s'\n" "$(esc "$DB_USERNAME")" >> deploy.env
          printf "DB_PASSWORD='%s'\n\n" "$(esc "$DB_PASSWORD")" >> deploy.env

          printf "JWT_SECRET='%s'\n\n" "$(esc "$JWT_SECRET")" >> deploy.env

          printf "OMNICHECK_API_KEY='%s'\n" "$(esc "$OMNICHECK_API_KEY")" >> deploy.env
          printf "OMNICHECK_BASE_URL='%s'\n" "$(esc "$OMNICHECK_BASE_URL")" >> deploy.env
          printf "OMNICHECK_DRY_RUN='false'\n\n" >> deploy.env

          printf "PAYFAST_ENABLED='%s'\n" "$(esc "$PAYFAST_ENABLED")" >> deploy.env
          printf "PAYFAST_MERCHANT_ID='%s'\n" "$(esc "$PAYFAST_MERCHANT_ID")" >> deploy.env
          printf "PAYFAST_MERCHANT_KEY='%s'\n" "$(esc "$PAYFAST_MERCHANT_KEY")" >> deploy.env
          printf "PAYFAST_PASSPHRASE='%s'\n" "$(esc "$PAYFAST_PASSPHRASE")" >> deploy.env
          printf "PAYFAST_URL='%s'\n" "$(esc "$PAYFAST_URL")" >> deploy.env
          printf "PAYFAST_RETURN_URL='%s'\n" "$(esc "$PAYFAST_RETURN_URL")" >> deploy.env
          printf "PAYFAST_CANCEL_URL='%s'\n" "$(esc "$PAYFAST_CANCEL_URL")" >> deploy.env
          printf "PAYFAST_NOTIFY_URL='%s'\n\n" "$(esc "$PAYFAST_NOTIFY_URL")" >> deploy.env

          printf "B2_APPLICATION_KEY_ID='%s'\n" "$(esc "$B2_APPLICATION_KEY_ID")" >> deploy.env
          printf "B2_APPLICATION_KEY_NAME='%s'\n" "$(esc "$B2_APPLICATION_KEY_NAME")" >> deploy.env
          printf "B2_APPLICATION_KEY='%s'\n" "$(esc "$B2_APPLICATION_KEY")" >> deploy.env
          printf "B2_BUCKET_ID='%s'\n" "$(esc "$B2_BUCKET_ID")" >> deploy.env
          printf "B2_BUCKET_NAME='%s'\n\n" "$(esc "$B2_BUCKET_NAME")" >> deploy.env

          printf "MAIL_HOST='%s'\n" "$(esc "$MAIL_HOST")" >> deploy.env
          printf "MAIL_PORT='%s'\n" "$(esc "$MAIL_PORT")" >> deploy.env
          printf "MAIL_USERNAME='%s'\n" "$(esc "$MAIL_USERNAME")" >> deploy.env
          printf "MAIL_PASSWORD='%s'\n\n" "$(esc "$MAIL_PASSWORD")" >> deploy.env

          printf "ALLOWED_ORIGINS='%s'\n" "$(esc "$ALLOWED_ORIGINS")" >> deploy.env

      - name: Copy JAR to droplet
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          source: target/marketplace-0.0.1-SNAPSHOT.jar
          target: /home/deploy/apps/dealio/target/

      - name: Copy env file to droplet
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          source: deploy.env
          target: /home/deploy/apps/dealio/target/

      - name: Move JAR, install env file, restart service
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            set -euo pipefail
            # Move the new JAR to the expected filename
            mv /home/deploy/apps/dealio/target/marketplace-0.0.1-SNAPSHOT.jar /home/deploy/apps/dealio/DealioApp.jar

            # Move env file into place and secure it
            sudo mv /home/deploy/apps/dealio/target/deploy.env /etc/default/marketplace
            sudo chown root:root /etc/default/marketplace
            sudo chmod 640 /etc/default/marketplace

            # Verify
            echo "Deployed JAR info:"
            ls -lh /home/deploy/apps/dealio/DealioApp.jar
            echo "Deployed env file:"
            sudo ls -l /etc/default/marketplace

            # Restart the service
            sudo systemctl daemon-reload || true
            sudo systemctl restart dealio
            sudo systemctl status dealio --no-pager
